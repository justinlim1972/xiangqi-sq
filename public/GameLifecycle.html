<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SG Xiangqi - Doctrine Visualizer</title>
    <style>
        :root { --primary: #cd3333; --dark: #05080c; --gold: #f1c40f; --text: #f8fafc; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--dark); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        header { background: #000; padding: 20px 40px; border-bottom: 2px solid var(--primary); display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        h1 { margin: 0; font-size: 1.5rem; letter-spacing: 2px; color: var(--primary); text-transform: uppercase; font-weight: 900; }
        
        .comic-container { flex-grow: 1; display: flex; position: relative; overflow: hidden; }

        /* LEFT SIDE: STORY NAV */
        .story-nav { width: 420px; background: #0a0e14; border-right: 1px solid #222; overflow-y: auto; padding: 20px; z-index: 10; }
        .panel-link { 
            background: #111; border: 1px solid #333; padding: 20px; border-radius: 12px; margin-bottom: 15px; 
            cursor: pointer; transition: 0.3s; position: relative; opacity: 0.6;
        }
        .panel-link:hover { background: #1a1a1a; opacity: 1; }
        .panel-link.active { border-color: var(--gold); opacity: 1; background: #161a20; box-shadow: 0 0 20px rgba(241, 196, 15, 0.15); }
        .panel-link span { display: block; font-size: 0.6rem; color: var(--gold); text-transform: uppercase; font-weight: 900; letter-spacing: 2px; margin-bottom: 5px; }
        .panel-link strong { display: block; font-size: 1rem; color: white; }
        .panel-link p { font-size: 0.75rem; color: #64748b; margin: 10px 0 0 0; line-height: 1.4; }

        /* RIGHT SIDE: VISUAL STAGE */
        .visual-stage { flex-grow: 1; position: relative; background: #000; display: flex; align-items: center; justify-content: center; padding: 40px; }
        #comic-image { width: 100%; height: 100%; object-fit: contain; border-radius: 8px; transition: opacity 0.8s ease-in-out; opacity: 0; }
        .image-overlay { position: absolute; bottom: 60px; left: 60px; right: 60px; background: rgba(0,0,0,0.9); padding: 30px; border-radius: 20px; border-left: 5px solid var(--primary); backdrop-filter: blur(10px); transform: translateY(100px); opacity: 0; transition: 0.5s ease-out; }
        .image-overlay.active { transform: translateY(0); opacity: 1; }
        .image-overlay h3 { margin: 0 0 10px 0; color: var(--gold); font-size: 1.2rem; }
        .image-overlay p { margin: 0; font-size: 0.9rem; line-height: 1.6; color: #cbd5e1; }

        /* LOADING */
        .loader-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 50; }
        .spinner { width: 50px; height: 50px; border: 5px solid #111; border-top-color: var(--gold); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<header>
    <h1>SG Xiangqi :: Doctrine Visualizer</h1>
    <a href="lobby.html" style="color: #64748b; font-size: 0.8rem; text-decoration: none; font-weight: 800;">LOBBY EXIT</a>
</header>

<div class="comic-container">
    <div class="story-nav" id="panel-list">
        <!-- Panels injected by JS -->
    </div>

    <div class="visual-stage">
        <div id="loader" class="loader-overlay">
            <div class="spinner"></div>
            <p style="margin-top:20px; font-weight:bold; color:var(--gold);">ILLUMINATING THE DOCTRINE...</p>
        </div>
        <img id="comic-image" src="" alt="Comic Visualization">
        <div id="caption-box" class="image-overlay">
            <h3 id="cap-title"></h3>
            <p id="cap-text"></p>
        </div>
    </div>
</div>

<script>
    const apiKey = "";
    const panels = [
        {
            title: "1. The Neutral State",
            desc: "Board is clean. matchActive: false. No pieces.",
            details: "The battlefield is empty. Orchestrator finds 'board: null' in Firestore. Personalization loads the board texture, but the armies remain unsummoned. Peace before the storm.",
            prompt: "Cinematic Manhua art. Zenith overhead view of an empty stone Xiangqi board in a misty mountain temple. Digital blue circuit lines glow underneath the wood. High resolution, 8k."
        },
        {
            title: "2. Claiming the Vanguard",
            desc: "Lobby status: WAITING. Seating engaged.",
            details: "Players sit. Avatars update in the lobby instantly. Board remains empty while players wait for the 'Engage Battle' agreement. The seats are claimed, but the war hasn't started.",
            prompt: "Digital Manhua painting. A Chinese general's avatar materializing into a glowing throne-like seat next to a digital grid. The text 'CHALLENGER WAITING' in gold calligraphy."
        },
        {
            title: "3. Summoning the Armies",
            desc: "Lobby status: PLAYING. Deployment starts.",
            details: "Agreement reached! 'Engage Battle' is clicked. Orchestrator runs Engine.init(). 32 pieces are saved to Firestore and pop into view for all observers simultaneously in their chosen style.",
            prompt: "Epic Manhua action. 32 Xiangqi pieces striking the board like meteors. Red and black electricity arcs between them. High contrast, cinematic masterpiece."
        },
        {
            title: "4. Diplomatic & Time Clashes",
            desc: "Active gameplay, Draw Offers, and Time Pressure.",
            details: "Players move and negotiate. Draw offers trigger popups for opponents (Accept/Reject). Clocks hit zero? The first client to detect the timeout signals the Orchestrator to end the game.",
            prompt: "Aggressive Manhua art. An hourglass made of red energy shattering while two generals meet at the center for a truce. Calligraphy for 'PEACE' and 'TIME' glowing like fire."
        },
        {
            title: "5. Termination Event",
            desc: "Checkmate, Resign, or Accepted Draw ends match.",
            details: "Game over detected. Status set to 'finished'. Winners earn their Identity Spoils (Mahjong Tile). Record is finalized. Board is still visible until the reset.",
            prompt: "Manhua victory shot. A golden Mahjong tile 'ðŸ€„' glowing on a pedestal. A defeated general's sword plunged into the ground. Particles of gold light filling the screen."
        },
        {
            title: "6. The Tactical Reset",
            desc: "Auto-Cleanup. Table returns to OPEN pool.",
            details: "Orchestrator clears the field: wipes 'board: null', clears seating, sets 'matchActive: false'. Pieces vanish. Table is recycled for the next challenge. The doctrine cycle is complete.",
            prompt: "Manhua digital painting. A digital 'Refresh' energy wave made of ink-wash strokes sweeping pieces off the board. The battlefield returning to its peaceful empty state. 8k."
        }
    ];

    let currentIndex = -1;

    function renderPanelList() {
        const list = document.getElementById('panel-list');
        panels.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = 'panel-link';
            div.id = `panel-${i}`;
            div.onclick = () => selectPanel(i);
            div.innerHTML = `
                <span>LOGIC PHASE ${i+1}</span>
                <strong>${p.title}</strong>
                <p>${p.desc}</p>
            `;
            list.appendChild(div);
        });
    }

    async function selectPanel(index) {
        if (index === currentIndex) return;
        currentIndex = index;

        document.querySelectorAll('.panel-link').forEach(l => l.classList.remove('active'));
        document.getElementById(`panel-${index}`).classList.add('active');
        
        const loader = document.getElementById('loader');
        const img = document.getElementById('comic-image');
        const cap = document.getElementById('caption-box');

        loader.style.display = 'flex';
        img.style.opacity = '0';
        cap.classList.remove('active');

        try {
            const data = await generateImage(panels[index].prompt);
            img.src = data;
            img.onload = () => {
                loader.style.display = 'none';
                img.style.opacity = '1';
                document.getElementById('cap-title').innerText = panels[index].title;
                document.getElementById('cap-text').innerText = panels[index].details;
                cap.classList.add('active');
            };
        } catch (e) {
            console.error(e);
            loader.style.display = 'none';
        }
    }

    async function generateImage(prompt) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;
        const resp = await fetch(url, {
            method: 'POST',
            body: JSON.stringify({ instances: { prompt }, parameters: { sampleCount: 1 } })
        });
        const res = await resp.json();
        return `data:image/png;base64,${res.predictions[0].bytesBase64Encoded}`;
    }

    document.addEventListener('DOMContentLoaded', () => {
        renderPanelList();
        selectPanel(0);
    });
</script>
</body>
</html>



http://googleusercontent.com/immersive_entry_chip/0

I have restored and updated the **Doctrine Visualizer** and the **Lifecycle Doctrine** text. They now explicitly include the Draw Negotiation and Time-Out logic. These files are our absolute development foundation. Summary of work:
* **Restored `lobby/backend_comic.html`**: Now titled "SG Xiangqi :: Doctrine Visualizer".
* **Updated Panels**: 6 logical phases mapping the entire lifecycle including cleanup.
* **Model Utilization**: `imagen-4.0-generate-001` used for the visual storyboard.
* **Markdown Synchronization**: Re-issued `lifecycle_doctrine.md` to ensure a local "Source of Truth."