<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SG Xiangqi - Precision Studio</title>
    <style>
        :root { --primary: #cd3333; --dark: #0a0a0a; --sidebar-bg: #111111; --stage-bg: #05080c; --yellow: #f1c40f; --white: #ffffff; }
        
        body { font-family: 'Segoe UI', sans-serif; background: var(--stage-bg); margin: 0; display: flex; height: 100vh; overflow: hidden; color: white; }
        
        /* Loading Overlay */
        #auth-loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--dark); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #222; border-top: 4px solid var(--yellow); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #sidebar { 
            width: 360px; 
            background: var(--sidebar-bg); 
            display: flex; 
            flex-direction: column; 
            flex-shrink: 0; 
            border-right: 2px solid rgba(255,255,255,0.05);
            overflow-y: auto;
            z-index: 100;
        }

        /* 1. NAVIGATION CONTROL (LOCKED AT TOP) */
        .nav-header { 
            background: #000; 
            padding: 25px; 
            border-bottom: 2px solid var(--primary); 
            margin-bottom: 10px;
        }
        .nav-group { display: flex; flex-direction: column; gap: 12px; }
        .nav-btn {
            background: #1a1a1a; border: 1px solid #333;
            color: #777; padding: 18px; border-radius: 12px; text-align: left;
            font-size: 1.1rem; font-weight: 900; cursor: pointer; transition: 0.3s;
            display: flex; justify-content: space-between; align-items: center;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .nav-btn:hover { background: #222; color: white; border-color: var(--yellow); }
        .nav-btn.active { background: var(--primary); color: white; border-color: transparent; box-shadow: 0 10px 20px rgba(205, 51, 51, 0.4); }

        .sidebar-header { padding: 20px 30px; }
        .sidebar-header h2 { margin: 0; font-size: 1rem; color: var(--yellow); letter-spacing: 2px; font-weight: 900; opacity: 0.5; }
        
        .menu-section { padding: 20px 25px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .section-title { font-size: 0.75rem; font-weight: 800; color: #555; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 20px; display: block; }

        /* Control Grids */
        .option-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .option-card { 
            background: #181818; border: 2px solid transparent; border-radius: 12px; 
            padding: 12px; cursor: pointer; transition: 0.3s; text-align: center;
        }
        .option-card.active { border-color: var(--primary); background: #252525; }
        .option-card span { font-size: 0.7rem; font-weight: 700; display: block; margin-top: 8px; color: #888; }
        
        .thumb-preview { width: 100%; aspect-ratio: 1/1; border-radius: 8px; overflow: hidden; background: #000; position: relative; border: 1px solid #333; display: flex; align-items: center; justify-content: center; }

        /* AVATAR DROPDOWN STYLE */
        .avatar-select {
            width: 100%; background: #1a1a1a; color: white; border: 2px solid #333;
            padding: 15px; border-radius: 10px; font-weight: 900; font-size: 1rem;
            cursor: pointer; outline: none; margin-bottom: 10px;
        }
        .avatar-select:focus { border-color: var(--yellow); }

        /* Main Area Management */
        main { flex-grow: 1; position: relative; overflow: hidden; background: radial-gradient(circle at center, #1a2333 0%, #05080c 100%); }
        
        .pane {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            padding: 40px; box-sizing: border-box;
        }
        .pane.active { display: flex; }

        /* BOARD VIEW */
        .stage-badge { 
            position: absolute; top: 40px; left: 40px; 
            background: rgba(0,0,0,0.7); padding: 12px 24px; 
            border-radius: 40px; border: 1px solid rgba(255,255,255,0.1); 
            backdrop-filter: blur(15px); z-index: 50; 
        }
        .stage-badge span { font-size: 0.65rem; text-transform: uppercase; color: var(--yellow); font-weight: 800; letter-spacing: 2px; }
        .stage-badge strong { font-size: 1.2rem; color: white; display: block; margin-top: 2px; }

        .viewport {
            width: 100%; max-width: 650px; aspect-ratio: 10 / 11;
            position: relative; border-radius: 12px; overflow: hidden;
            box-shadow: 0 80px 150px rgba(0,0,0,0.9); background: #000;
        }
        #full-bg-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background-size: cover; background-position: center; transition: 0.8s ease; filter: brightness(1.2); }
        .vignette { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; background: radial-gradient(circle, transparent 20%, rgba(0,0,0,0.7) 100%); pointer-events: none; }
        .board-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 82%; height: 82%; z-index: 3; box-shadow: 0 20px 80px rgba(0,0,0,1); border: 15px solid #2a1a10; background: #dcb35c; }
        #board-stage { width: 100%; height: 100%; position: relative; }
        #pieces-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }

        /* AVATAR GALLERY VIEW */
        .gallery-container { width: 100%; max-width: 1200px; height: 100%; overflow-y: auto; padding: 20px; }
        .gallery-header { text-align: center; margin-bottom: 40px; }
        .gallery-header h1 { font-size: 3rem; color: var(--yellow); letter-spacing: 5px; margin: 0; font-weight: 900; }
        .gallery-header p { color: #64748b; margin-top: 10px; font-weight: 500; }
        
        .avatar-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); 
            gap: 20px; 
            padding: 20px;
        }
        .avatar-card {
            aspect-ratio: 1/1; background: #111; border: 4px solid transparent;
            border-radius: 16px; cursor: pointer; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden; position: relative;
            /* PERFORMANCE: Skip rendering work for cards not on screen */
            content-visibility: auto;
            contain-intrinsic-size: 110px 110px;
        }
        .avatar-card img { width: 100%; height: 100%; object-fit: cover; filter: brightness(0.6); }
        .avatar-card:hover { transform: translateY(-10px); border-color: rgba(241, 196, 15, 0.4); }
        .avatar-card:hover img { filter: brightness(1); }
        .avatar-card.active { border-color: var(--yellow); box-shadow: 0 10px 30px rgba(241, 196, 15, 0.5); }
        .avatar-card.active img { filter: brightness(1.2); }
        .avatar-card .idx-tag {
            position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.8);
            color: white; font-size: 0.7rem; padding: 3px 8px; border-radius: 6px; font-weight: 900;
        }

        /* IDENTITY BUBBLE */
        .id-bubble { 
            position: fixed; top: 40px; right: 40px; background: rgba(0,0,0,0.9); 
            padding: 20px; border-radius: 30px; border: 3px solid var(--yellow); 
            display: flex; flex-direction: column; align-items: center; z-index: 1000; 
            box-shadow: 0 30px 60px rgba(0,0,0,0.8); backdrop-filter: blur(10px);
        }
        .id-crop { 
            width: 110px; height: 110px; border-radius: 50%; overflow: hidden; 
            background: #000; border: 3px solid #222; margin-bottom: 10px; 
        }
        #current-avatar-preview { width: 100%; height: 100%; object-fit: cover; }

        /* Footer */
        .sidebar-footer { padding: 30px; border-top: 1px solid rgba(255,255,255,0.1); background: #0a0a0a; }
        .btn-save { background: var(--primary); color: white; border: none; padding: 20px; border-radius: 12px; font-weight: 900; cursor: pointer; width: 100%; transition: 0.3s; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 2px; }
        .btn-save:hover { background: #a02828; transform: translateY(-2px); }
        .status-msg { margin-top: 15px; font-size: 0.85rem; font-weight: bold; text-align: center; color: var(--yellow); }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
    </style>
</head>
<body>

<div id="auth-loading-overlay">
    <div class="spinner"></div>
    <p style="margin-top: 20px; font-weight: bold; letter-spacing: 3px; color: #555;">SYNCING STUDIO...</p>
</div>

<div id="sidebar">
    <div class="nav-header">
        <div class="nav-group">
            <button class="nav-btn active" id="nav-studio" onclick="switchStudioMode('studio')">Board Designer</button>
            <button class="nav-btn" id="nav-avatar" onclick="switchStudioMode('avatar')">Player Avatar</button>
        </div>
    </div>

    <div class="sidebar-header">
        <h2 id="mode-title">DESIGNER</h2>
    </div>

    <!-- 1. BOARD DESIGNER CONTROLS -->
    <div id="designer-controls">
        <div class="menu-section">
            <span class="section-title">Army Style</span>
            <div class="option-grid" id="piece-menu">
                <div class="option-card active" data-val="ivory" onclick="selectItem('piece', 'ivory', this)"><div class="thumb-preview" id="thumb-p-ivory"></div><span>Imperial Ivory</span></div>
                <div class="option-card" data-val="jade" onclick="selectItem('piece', 'jade', this)"><div class="thumb-preview" id="thumb-p-jade"></div><span>Polished Jade</span></div>
                <div class="option-card" data-val="flat" onclick="selectItem('piece', 'flat', this)"><div class="thumb-preview" id="thumb-p-flat"></div><span>Modern Flat</span></div>
                <div class="option-card" data-val="wood" onclick="selectItem('piece', 'wood', this)"><div class="thumb-preview" id="thumb-p-wood"></div><span>Carved Rosewood</span></div>
            </div>
        </div>

        <div class="menu-section">
            <span class="section-title">Surface Texture</span>
            <div class="option-grid" id="board-menu">
                <div class="option-card active" data-val="classic" onclick="selectItem('board', 'classic', this)"><div class="thumb-preview" id="thumb-b-classic"></div><span>Classic Wood</span></div>
                <div class="option-card" data-val="emerald" onclick="selectItem('board', 'emerald', this)"><div class="thumb-preview" id="thumb-b-emerald"></div><span>Emerald Marble</span></div>
                <div class="option-card" data-val="slate" onclick="selectItem('board', 'slate', this)"><div class="thumb-preview" id="thumb-b-slate"></div><span>Minimalist Slate</span></div>
                <div class="option-card" data-val="mahogany" onclick="selectItem('board', 'mahogany', this)"><div class="thumb-preview" id="thumb-b-mahogany"></div><span>Dark Mahogany</span></div>
            </div>
        </div>

        <div class="menu-section">
            <span class="section-title">Battle Environment</span>
            <div class="option-grid" id="environment-menu">
                <div class="option-card active" data-val="forest" onclick="selectItem('environment', 'forest', this)"><div class="thumb-preview" id="thumb-e-forest" style="background-image: url('https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=1200'); background-size: cover; background-position: center center;"></div><span>Misty Forest</span></div>
                <div class="option-card" data-val="pyramid" onclick="selectItem('environment', 'pyramid', this)"><div class="thumb-preview" id="thumb-e-pyramid" style="background-image: url('https://images.unsplash.com/photo-1572252009286-268acec5ca0a?q=80&w=1200'); background-size: cover; background-position: center center;"></div><span>Egyptian Pyramid</span></div>
                <div class="option-card" data-val="greatwall" onclick="selectItem('environment', 'greatwall', this)"><div class="thumb-preview" id="thumb-e-greatwall" style="background-image: url('https://images.unsplash.com/photo-1508804185872-d7badad00f7d?q=80&w=1200'); background-size: cover; background-position: center center;"></div><span>Great Wall</span></div>
                <div class="option-card" data-val="temple" onclick="selectItem('environment', 'temple', this)"><div class="thumb-preview" id="thumb-e-temple" style="background-image: url('https://images.unsplash.com/photo-1545569341-9eb8b30979d9?q=80&w=1200'); background-size: cover; background-position: center center;"></div><span>Asian Temple</span></div>
                <div class="option-card" data-val="mountains" onclick="selectItem('environment', 'mountains', this)"><div class="thumb-preview" id="thumb-e-mountains" style="background-image: url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?q=80&w=1200'); background-size: cover; background-position: center center;"></div><span>Snow Mountains</span></div>
                <div class="option-card" data-val="ocean" onclick="selectItem('environment', 'ocean', this)"><div class="thumb-preview" id="thumb-e-ocean" style="background-image: url('https://images.unsplash.com/photo-1505142468610-359e7d316be0?q=80&w=1200'); background-size: cover; background-position: center center;"></div><span>Ocean Waves</span></div>
                <div class="option-card" data-val="aurora" onclick="selectItem('environment', 'aurora', this)"><div class="thumb-preview" id="thumb-e-aurora" style="background-image: url('https://images.unsplash.com/photo-1579033461380-adb47c3eb938?q=80&w=1200'); background-size: cover; background-position: center center;"></div><span>Northern Lights</span></div>
                <div class="option-card" data-val="volcano" onclick="selectItem('environment', 'volcano', this)"><div class="thumb-preview" id="thumb-e-volcano" style="background-image: url('https://images.unsplash.com/photo-1603487742131-4160ec999306?q=80&w=1200'); background-size: cover; background-position: center center;"></div><span>Volcanic Lava</span></div>
            </div>
        </div>
    </div>

    <!-- 2. AVATAR PICKER CONTROLS (DROPDOWN) -->
    <div id="avatar-controls" style="display:none;">
        <div class="menu-section">
            <span class="section-title">Jump to Portrait</span>
            <select class="avatar-select" id="avatar-jump-menu" onchange="jumpToAvatar(this.value)">
                <!-- Options populated by JS -->
            </select>
            <p style="font-size: 0.8rem; color: #555; line-height: 1.5; margin-top: 15px;">
                Select a specific number from the list or browse the visual gallery on the right.
            </p>
        </div>
    </div>

    <div class="sidebar-footer">
        <button class="btn-save" onclick="applyAndSave()">Lock In Setup</button>
        <span id="global-status" class="status-msg"></span>
        <a href="lobby.html" style="color: #444; font-size: 0.75rem; text-decoration: none; display: block; text-align: center; margin-top: 25px; font-weight: 800; letter-spacing: 2px;">LOBBY EXIT</a>
    </div>
</div>

<main>
    <!-- MODE 1: THE DESIGNER -->
    <div id="pane-studio" class="pane active">
        <div class="stage-badge">
            <span>Precision Environment</span>
            <strong id="player-label">Standard Setup</strong>
        </div>
        <div class="viewport">
            <div id="full-bg-layer" style="background-image: url('https://images.unsplash.com/photo-1508804185872-d7badad00f7d?q=80&w=1200');"></div>
            <div class="vignette"></div>
            <div class="board-container">
                <div id="board-stage">
                    <div id="pieces-layer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODE 2: THE AVATAR GALLERY -->
    <div id="pane-avatar" class="pane">
        <div class="id-bubble">
            <div class="id-crop"><img id="current-avatar-preview" src="/lobby/1.JPG"></div>
            <span style="font-size: 0.6rem; color: var(--yellow); font-weight: 900; letter-spacing: 2px;">MY IDENTITY</span>
        </div>

        <div class="gallery-container">
            <div class="gallery-header">
                <h1>Portrait Collection</h1>
                <p>Choose from 100 unique identities to represent your rank.</p>
            </div>
            <div class="avatar-grid" id="main-gallery-grid">
                <!-- Grid populated by JS -->
            </div>
        </div>
    </div>
</main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDq_LECOrc4SY90SyDsBQGmwl-YnUNFIj8",
        authDomain: "xiangqi-sq.firebaseapp.com",
        projectId: "xiangqi-sq",
        storageBucket: "xiangqi-sq.firebasestorage.app",
        messagingSenderId: "351923336298",
        appId: "1:351923336298:web:e7278ea095ba085ac4935b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = 'sg-xiangqi';

    let currentUid = null;
    let selections = {
        piece: 'ivory',
        board: 'classic',
        environment: 'forest',
        avatarUrl: '/lobby/1.JPG'
    };

    const pieceTemplates = {
        ivory: (char, isRed) => `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="46" fill="#fdfaf0" stroke="#d4c9b0" stroke-width="2"/><text x="50" y="72" text-anchor="middle" font-size="60" font-family="serif" fill="${isRed ? '#cd3333' : '#222'}" font-weight="bold">${char}</text></svg>`,
        jade: (char, isRed) => `<svg viewBox="0 0 100 100"><defs><radialGradient id="g-${char}-${isRed}" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="${isRed ? '#ff6666' : '#2d5a27'}" /><stop offset="100%" stop-color="${isRed ? '#800000' : '#0a1a08'}" /></radialGradient></defs><circle cx="50" cy="50" r="46" fill="url(#g-${char}-${isRed})" stroke="#fff" stroke-width="3" opacity="0.9"/><text x="50" y="70" text-anchor="middle" font-size="55" font-family="sans-serif" fill="#fff" font-weight="900">${char}</text></svg>`,
        flat: (char, isRed) => `<svg viewBox="0 0 100 100"><rect x="5" y="5" width="90" height="90" rx="18" fill="${isRed ? '#ef4444' : '#1e293b'}"/><text x="50" y="75" text-anchor="middle" font-size="65" font-family="Arial" fill="#fff" font-weight="bold">${char}</text></svg>`,
        wood: (char, isRed) => `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="48" fill="${isRed ? '#5a3a2a' : '#1e1e1e'}" stroke="${isRed ? '#2a1a10' : '#000'}" stroke-width="3"/><text x="50" y="72" text-anchor="middle" font-size="55" font-family="serif" fill="${isRed ? '#facc15' : '#cbd5e1'}" font-weight="bold">${char}</text></svg>`
    };

    function genBoard(bg, s) {
        let l = "";
        for(let i=0; i<9; i++) { let x = 10 + i * 10; l += `<line x1="${x}" y1="10" x2="${x}" y2="50" stroke="${s}" stroke-width="0.5" /><line x1="${x}" y1="60" x2="${x}" y2="100" stroke="${s}" stroke-width="0.5" />`; }
        for(let i=0; i<10; i++) { let y = 10 + i * 10; l += `<line x1="10" y1="${y}" x2="90" y2="${y}" stroke="${s}" stroke-width="0.5" />`; }
        l += `<rect x="10" y="10" width="80" height="90" fill="none" stroke="${s}" stroke-width="1.2" />`;
        const palace = `<line x1="40" y1="10" x2="60" y2="30" stroke="${s}" stroke-width="0.5" /><line x1="60" y1="10" x2="40" y2="30" stroke="${s}" stroke-width="0.5" /><line x1="40" y1="80" x2="60" y2="100" stroke="${s}" stroke-width="0.5" /><line x1="60" y1="80" x2="40" y2="100" stroke="${s}" stroke-width="0.5" />`;
        return `<svg style="width:100%;height:100%;background:${bg};display:block;" viewBox="0 0 100 110" preserveAspectRatio="none">${l}${palace}<text x="30" y="56" text-anchor="middle" font-size="4" fill="${s}" font-weight="900" opacity="0.6">楚河</text><text x="70" y="56" text-anchor="middle" font-size="4" fill="${s}" font-weight="900" opacity="0.6">漢界</text></svg>`;
    }

    const boardTemplates = {
        classic: () => genBoard("#dcb35c", "#5d2e0c"),
        emerald: () => genBoard("#0a3d2e", "#a8e6cf"),
        slate: () => genBoard("#f0f2f5", "#2c3e50"),
        mahogany: () => genBoard("#2a1817", "#facc15")
    };

    const environmentTemplates = {
        forest: { url: 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=1200', position: 'center center' },
        pyramid: { url: 'https://images.unsplash.com/photo-1572252009286-268acec5ca0a?q=80&w=1200', position: 'center center' },
        greatwall: { url: 'https://images.unsplash.com/photo-1508804185872-d7badad00f7d?q=80&w=1200', position: 'center center' },
        temple: { url: 'https://images.unsplash.com/photo-1545569341-9eb8b30979d9?q=80&w=1200', position: 'center center' },
        mountains: { url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?q=80&w=1200', position: 'center center' },
        ocean: { url: 'https://images.unsplash.com/photo-1505142468610-359e7d316be0?q=80&w=1200', position: 'center center' },
        aurora: { url: 'https://images.unsplash.com/photo-1579033461380-adb47c3eb938?q=80&w=1200', position: 'center center' },
        volcano: { url: 'https://images.unsplash.com/photo-1603487742131-4160ec999306?q=80&w=1200', position: 'center center' }
    };

    const openingPositions = [
        { x: 0, y: 0, char: '車', isRed: false }, { x: 1, y: 0, char: '马', isRed: false }, { x: 2, y: 0, char: '象', isRed: false }, { x: 3, y: 0, char: '士', isRed: false }, { x: 4, y: 0, char: '将', isRed: false }, { x: 5, y: 0, char: '士', isRed: false }, { x: 6, y: 0, char: '象', isRed: false }, { x: 7, y: 0, char: '马', isRed: false }, { x: 8, y: 0, char: '車', isRed: false },
        { x: 1, y: 2, char: '砲', isRed: false }, { x: 7, y: 2, char: '砲', isRed: false },
        { x: 0, y: 3, char: '卒', isRed: false }, { x: 2, y: 3, char: '卒', isRed: false }, { x: 4, y: 3, char: '卒', isRed: false }, { x: 6, y: 3, char: '卒', isRed: false }, { x: 8, y: 3, char: '卒', isRed: false },
        { x: 0, y: 9, char: '俥', isRed: true }, { x: 1, y: 9, char: '傌', isRed: true }, { x: 2, y: 9, char: '相', isRed: true }, { x: 3, y: 9, char: '仕', isRed: true }, { x: 4, y: 9, char: '帥', isRed: true }, { x: 5, y: 9, char: '仕', isRed: true }, { x: 6, y: 9, char: '相', isRed: true }, { x: 7, y: 9, char: '傌', isRed: true }, { x: 8, y: 9, char: '俥', isRed: true },
        { x: 1, y: 7, char: '炮', isRed: true }, { x: 7, y: 7, char: '炮', isRed: true },
        { x: 0, y: 6, char: '兵', isRed: true }, { x: 2, y: 6, char: '兵', isRed: true }, { x: 4, y: 6, char: '兵', isRed: true }, { x: 6, y: 6, char: '兵', isRed: true }, { x: 8, y: 6, char: '兵', isRed: true }
    ];

    window.switchStudioMode = (mode) => {
        const isStudio = mode === 'studio';
        document.getElementById('pane-studio').classList.toggle('active', isStudio);
        document.getElementById('pane-avatar').classList.toggle('active', !isStudio);
        document.getElementById('nav-studio').classList.toggle('active', isStudio);
        document.getElementById('nav-avatar').classList.toggle('active', !isStudio);
        document.getElementById('designer-controls').style.display = isStudio ? 'block' : 'none';
        document.getElementById('avatar-controls').style.display = isStudio ? 'none' : 'block';
        document.getElementById('mode-title').innerText = isStudio ? 'DESIGNER' : 'IDENTITY';
    };

    function buildGallery() {
        const grid = document.getElementById('main-gallery-grid');
        const jumpMenu = document.getElementById('avatar-jump-menu');
        
        for (let i = 1; i <= 100; i++) {
            const filename = `${i}.JPG`;
            // Using ABSOLUTE WEB PATH
            const absolutePath = `/lobby/${filename}`;
            
            const card = document.createElement('div');
            card.className = 'avatar-card';
            card.id = `card-${filename}`;
            card.onclick = () => pickAvatar(absolutePath);
            card.innerHTML = `
                <img src="${absolutePath}" 
                     width="110" height="110" 
                     loading="lazy" 
                     decoding="async"
                     onerror="this.src='https://via.placeholder.com/150?text=${i}'">
                <div class="idx-tag">${i}</div>
            `;
            grid.appendChild(card);
            
            const opt = document.createElement('option');
            opt.value = absolutePath;
            opt.innerText = `Portrait #${i}`;
            jumpMenu.appendChild(opt);
        }
    }

    window.pickAvatar = (fullPath) => {
        selections.avatarUrl = fullPath;
        document.getElementById('avatar-jump-menu').value = fullPath;
        
        // Extract filename from path for ID selection
        const filename = fullPath.split('/').pop();
        document.querySelectorAll('.avatar-card').forEach(c => c.classList.remove('active'));
        const activeCard = document.getElementById(`card-${filename}`);
        if (activeCard) activeCard.classList.add('active');
        
        document.getElementById('current-avatar-preview').src = fullPath;
    };

    window.jumpToAvatar = (val) => {
        pickAvatar(val);
        const filename = val.split('/').pop();
        const el = document.getElementById(`card-${filename}`);
        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    };

    window.selectItem = (type, value, el) => {
        selections[type] = value;
        Array.from(el.parentElement.children).forEach(s => s.classList.remove('active'));
        el.classList.add('active');
        renderStage();
    };

    function renderStage() {
        const stage = document.getElementById('board-stage'); if(!stage) return;
        const oldSvg = stage.querySelector('svg'); if (oldSvg) oldSvg.remove();
        stage.insertAdjacentHTML('afterbegin', boardTemplates[selections.board]());

        // Update environment background
        const bgLayer = document.getElementById('full-bg-layer');
        if (bgLayer) {
            const envData = environmentTemplates[selections.environment];
            bgLayer.style.backgroundImage = `url('${envData.url}')`;
            bgLayer.style.backgroundPosition = envData.position;
        }

        const layer = document.getElementById('pieces-layer'); layer.innerHTML = "";
        openingPositions.forEach(p => {
            const d = document.createElement('div'); d.style.position = "absolute"; d.style.width = "9.1%"; d.style.left = `${10 + p.x * 10}%`; d.style.top = `${((10 + p.y * 10) / 110) * 100}%`; d.style.transform = "translate(-50%, -50%)";
            d.innerHTML = pieceTemplates[selections.piece](p.char, p.isRed); layer.appendChild(d);
        });
    }

    window.applyAndSave = async () => {
        const msg = document.getElementById('global-status');
        msg.innerText = "Synchronizing Preferences...";
        try {
            const profileRef = doc(db, 'artifacts', appId, 'users', currentUid, 'profile', 'data');
            await updateDoc(profileRef, {
                pieceSet: selections.piece,
                boardSet: selections.board,
                environmentBg: selections.environment,
                avatarUrl: selections.avatarUrl
            });
            msg.style.color = "#27ae60"; msg.innerText = "✓ Style & Identity Secured";
            setTimeout(() => msg.innerText = "", 3000);
        } catch (e) { msg.style.color = "#cd3333"; msg.innerText = "Error: " + e.message; }
    };

    onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = '../index.html'; return; }
        currentUid = user.uid;
        const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data');
        const snap = await getDoc(profileRef);
        
        if (snap.exists()) {
            const d = snap.data();
            selections.piece = d.pieceSet || 'ivory';
            selections.board = d.boardSet || 'classic';
            selections.environment = d.environmentBg || 'forest';
            selections.avatarUrl = d.avatarUrl || '/lobby/1.JPG';
            if (d.playerName) document.getElementById('player-label').innerText = d.playerName;

            ['piece', 'board', 'environment'].forEach(type => {
                const val = selections[type];
                const menu = document.getElementById(`${type}-menu`);
                if (menu) {
                    Array.from(menu.children).forEach(card => card.classList.toggle('active', card.getAttribute('data-val') === val));
                }
            });
        }
        
        document.getElementById('auth-loading-overlay').style.display = 'none';
        pickAvatar(selections.avatarUrl);
        renderStage();
    });

    document.addEventListener('DOMContentLoaded', () => {
        buildGallery();
        ['ivory', 'jade', 'flat', 'wood'].forEach(s => {
            const el = document.getElementById(`thumb-p-${s}`);
            if(el) el.innerHTML = `<div style="width:60%;">${pieceTemplates[s]('帥', true)}</div>`;
        });
        ['classic', 'emerald', 'slate', 'mahogany'].forEach(s => {
            const el = document.getElementById(`thumb-b-${s}`);
            if(el) el.innerHTML = boardTemplates[s]();
        });
        ['forest', 'pyramid', 'greatwall', 'temple', 'mountains', 'ocean', 'aurora', 'volcano'].forEach(s => {
            const el = document.getElementById(`thumb-e-${s}`);
            console.log('Setting environment thumbnail for:', s, el);
            if(el) {
                const envData = environmentTemplates[s];
                el.style.backgroundImage = `url('${envData.url}')`;
                el.style.backgroundSize = 'cover';
                el.style.backgroundPosition = envData.position;
                console.log('Set background to:', el.style.backgroundImage);
            }
        });
        renderStage();
    });
</script>
</body>
</html>