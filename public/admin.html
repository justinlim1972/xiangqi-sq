<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SG Xiangqi - Admin Command</title>
    <!-- v2.0 - Lecture Hall Support -->
    <style>
        :root { --primary: #cd3333; --dark: #1e293b; --bg: #f8fafc; --gold: #f1c40f; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        
        header { background: var(--primary); color: white; padding: 15px 25px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 1.4rem; font-weight: 800; letter-spacing: -1px; }

        .dashboard-grid { display: grid; grid-template-columns: 350px 1fr; gap: 30px; }
        .full-width { grid-column: 1 / -1; }
        
        .card { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; margin-bottom: 20px; }
        .card h2 { margin-top: 0; font-size: 1.1rem; border-bottom: 2px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }

        /* Region List */
        .item-list { display: flex; flex-direction: column; gap: 10px; }
        .item { padding: 15px; border-radius: 10px; background: #f1f5f9; border: 2px solid transparent; cursor: pointer; transition: 0.2s; position: relative; }
        .item:hover { background: #e2e8f0; }
        .item.active { border-color: var(--primary); background: white; box-shadow: 0 4px 12px rgba(205, 51, 51, 0.1); }
        .item strong { display: block; font-size: 1rem; }
        .item small { color: #64748b; font-weight: bold; }
        
        .btn-del-region { position: absolute; top: 10px; right: 10px; background: none; border: none; color: #ccc; cursor: pointer; font-size: 1.2rem; }
        .btn-del-region:hover { color: #ef4444; }

        .region-controls { position: absolute; top: 10px; right: 40px; display: flex; flex-direction: column; gap: 2px; }
        .btn-reorder { background: none; border: none; color: #94a3b8; cursor: pointer; font-size: 0.9rem; padding: 2px 5px; line-height: 1; }
        .btn-reorder:hover { color: var(--primary); }

        /* Table Editor */
        .table-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .table-card { border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; background: #fff; position: relative; }
        .table-card h3 { margin: 0 0 10px 0; font-size: 0.9rem; color: #64748b; }

        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; color: #94a3b8; margin-bottom: 5px; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }

        .btn { border: none; padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 0.8rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-reset { background: #0f172a; color: var(--gold); }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-sm { padding: 6px 10px; font-size: 0.7rem; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }

        #auth-guard { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; align-items:center; justify-content:center; flex-direction:column; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* User Management Table */
        .user-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .user-table th { background: #f8fafc; text-align: left; padding: 12px; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; color: #64748b; border-bottom: 2px solid #e2e8f0; }
        .user-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; }
        .user-table tr:hover { background: #f8fafc; }
        .status-online { color: #10b981; font-weight: bold; }
        .status-offline { color: #94a3b8; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; }
        .badge-admin { background: #fef3c7; color: #92400e; }
        .badge-user { background: #e0e7ff; color: #3730a3; }
    </style>
</head>
<body>

<div id="auth-guard">
    <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
    <p>Verifying Credentials...</p>
</div>

<header>
    <h1>SG Xiangqi :: Admin Terminal</h1>
    <div style="display: flex; gap: 10px;">
        <button class="btn" style="background:var(--gold); color:#000; font-weight:900;" onclick="forceFixOrdering()">üîß Fix Region Order</button>
        <button class="btn" style="background:#10b981; color:white; font-weight:900;" onclick="toggleUserManagement()">üë• User Management</button>
        <button class="btn" style="background:rgba(255,255,255,0.2); color:white;" onclick="window.location.href=window.location.origin + '/lobby/lobby.html'">Exit to Lobby</button>
    </div>
</header>

<div class="dashboard-grid">
    <!-- USER MANAGEMENT SECTION (Hidden by default) -->
    <div id="user-management-section" class="card full-width" style="display:none;">
        <h2>
            üë• User Management
            <button class="btn btn-sm" style="background:#64748b; color:white;" onclick="toggleUserManagement()">Back to Region Management</button>
        </h2>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
            <div style="background: #f0fdf4; padding: 15px; border-radius: 10px; border-left: 4px solid #10b981;">
                <div style="font-size: 0.75rem; color: #166534; font-weight: 700; text-transform: uppercase;">Total Users</div>
                <div id="total-users" style="font-size: 1.8rem; font-weight: 900; color: #064e3b; margin-top: 5px;">-</div>
            </div>
            <div style="background: #eff6ff; padding: 15px; border-radius: 10px; border-left: 4px solid #3b82f6;">
                <div style="font-size: 0.75rem; color: #1e40af; font-weight: 700; text-transform: uppercase;">Online Now</div>
                <div id="online-users" style="font-size: 1.8rem; font-weight: 900; color: #1e3a8a; margin-top: 5px;">-</div>
            </div>
            <div style="background: #fef3c7; padding: 15px; border-radius: 10px; border-left: 4px solid #f59e0b;">
                <div style="font-size: 0.75rem; color: #92400e; font-weight: 700; text-transform: uppercase;">Active Today</div>
                <div id="active-today" style="font-size: 1.8rem; font-weight: 900; color: #78350f; margin-top: 5px;">-</div>
            </div>
            <div style="background: #fce7f3; padding: 15px; border-radius: 10px; border-left: 4px solid #ec4899;">
                <div style="font-size: 0.75rem; color: #9f1239; font-weight: 700; text-transform: uppercase;">Admins</div>
                <div id="admin-count" style="font-size: 1.8rem; font-weight: 900; color: #831843; margin-top: 5px;">-</div>
            </div>
        </div>
        <table class="user-table" id="user-table">
            <thead>
                <tr>
                    <th>UID</th>
                    <th>Player Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Last Login</th>
                    <th>Session Duration</th>
                    <th>Games Played</th>
                    <th>Last Table</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="user-table-body">
                <tr><td colspan="10" style="text-align:center; padding:40px; color:#94a3b8;">Loading user data...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- REGION COLUMN -->
    <aside id="region-column">
        <div class="card">
            <h2>Regions <button class="btn btn-primary btn-sm" onclick="showAddRegion()">+ Add</button></h2>
            <div id="region-list" class="item-list">
                <p style="color:#94a3b8; font-size:0.8rem;">Loading regions...</p>
            </div>
        </div>

        <!-- NEW: REGION EDITOR -->
        <div id="region-editor-card" class="card" style="display:none;">
            <h2>Region Settings <span id="region-type-badge" style="font-size:0.8rem; padding:4px 8px; border-radius:6px; background:#e2e8f0; color:#64748b;"></span></h2>
            <div class="form-group">
                <label>Region Name</label>
                <input type="text" id="edit-reg-name">
            </div>

            <!-- Game Region Settings -->
            <div id="edit-game-fields" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="form-group">
                    <label>Base (Min)</label>
                    <input type="number" id="edit-reg-time">
                </div>
                <div class="form-group">
                    <label>Incr (Sec)</label>
                    <input type="number" id="edit-reg-inc">
                </div>
            </div>

            <!-- Lecture Region Settings -->
            <div id="edit-lecture-fields" style="display:none;">
                <div class="form-group">
                    <label>Lecturer Password</label>
                    <input type="password" id="edit-reg-password" placeholder="Enter new password (leave blank to keep current)">
                </div>
                <div class="form-group">
                    <label>Max Tables</label>
                    <input type="number" id="edit-reg-max-tables" min="1" max="10">
                </div>
                <div class="form-group">
                    <label>Max Students per Table</label>
                    <input type="number" id="edit-reg-max-students" min="1" max="100">
                </div>
            </div>

            <button class="btn btn-success" style="width:100%" onclick="updateRegionSettings()">Save Region Details</button>
        </div>
    </aside>

    <!-- TABLES COLUMN -->
    <main id="tables-column">
        <div class="card">
            <h2>
                Table Management 
                <div style="display:flex; gap:10px;">
                    <button id="mass-reset-btn" class="btn btn-warning btn-sm" style="display:none;" onclick="adminMassReset()">FLUSH ALL TABLES üßπ</button>
                    <button id="add-table-btn" class="btn btn-primary btn-sm" style="display:none;" onclick="showAddTable()">+ New Table</button>
                </div>
            </h2>
            <div id="table-container" class="table-grid">
                <p style="color:#94a3b8; padding: 40px; text-align: center; width: 100%;">Select a region to manage tables.</p>
            </div>
        </div>
    </main>
</div>

<!-- MODALS -->
<div id="region-modal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top: 0; margin-bottom: 25px; font-size: 1.3rem;">Create New Region</h3>

        <!-- Region Type Selection - MUST BE FIRST -->
        <div class="form-group">
            <label style="font-size: 0.85rem; color: #475569;">REGION TYPE</label>
            <select id="reg-type" onchange="toggleLectureFields()" style="width: 100%; padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1rem; cursor: pointer;">
                <option value="game">üéÆ Game Region (Normal Play)</option>
                <option value="lecture">üéì Lecture Hall (Teaching)</option>
            </select>
        </div>

        <div class="form-group">
            <label style="font-size: 0.85rem; color: #475569;">REGION NAME</label>
            <input type="text" id="reg-name" placeholder="e.g. Jurong East" style="font-size: 1rem;">
        </div>

        <!-- Game Region Fields -->
        <div id="game-fields">
            <div class="form-group">
                <label style="font-size: 0.85rem; color: #475569;">BASE TIME (MINUTES)</label>
                <input type="number" id="reg-time" value="10" style="font-size: 1rem;">
            </div>
            <div class="form-group">
                <label style="font-size: 0.85rem; color: #475569;">INCREMENT (SECONDS)</label>
                <input type="number" id="reg-inc" value="5" style="font-size: 1rem;">
            </div>
        </div>

        <!-- Lecture Region Fields (Hidden by default) -->
        <div id="lecture-fields" style="display:none;">
            <div class="form-group">
                <label style="font-size: 0.85rem; color: #475569;">LECTURER PASSWORD</label>
                <input type="password" id="reg-password" placeholder="Enter password for lecturers" style="font-size: 1rem;">
            </div>
            <div class="form-group">
                <label style="font-size: 0.85rem; color: #475569;">MAX TABLES (1-10)</label>
                <input type="number" id="reg-max-tables" value="3" min="1" max="10" style="font-size: 1rem;">
            </div>
            <div class="form-group">
                <label style="font-size: 0.85rem; color: #475569;">MAX STUDENTS/OBSERVERS PER TABLE</label>
                <input type="number" id="reg-max-students" value="50" min="1" max="100" style="font-size: 1rem;">
            </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:25px;">
            <button class="btn btn-success" style="flex:1; font-size: 1rem; padding: 12px;" onclick="createRegion()">Create</button>
            <button class="btn btn-danger" style="font-size: 1rem; padding: 12px;" onclick="closeModals()">Cancel</button>
        </div>
    </div>
</div>

<div id="table-modal" class="modal">
    <div class="modal-content">
        <h3>Create New Table</h3>
        <div class="form-group"><label>Table Name</label><input type="text" id="tab-name" placeholder="Table 1"></div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn btn-success" style="flex:1" onclick="createTable()">Create</button>
            <button class="btn btn-danger" onclick="closeModals()">Cancel</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, onSnapshot, query, orderBy, setDoc, addDoc, updateDoc, deleteDoc, serverTimestamp, deleteField, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyDq_LECOrc4SY90SyDsBQGmwl-YnUNFIj8", authDomain: "xiangqi-sq.firebaseapp.com", projectId: "xiangqi-sq", storageBucket: "xiangqi-sq.firebasestorage.app", messagingSenderId: "351923336298", appId: "1:351923336298:web:e7278ea095ba085ac4935b" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = "sg-xiangqi";

    let activeRegionId = null;
    let tablesUnsubscribe = null;

    onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = window.location.origin + '/index.html'; return; }

        onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data'), async (snap) => {
            if (snap.exists() && snap.data().role === 'admin') {
                document.getElementById('auth-guard').style.display = 'none';

                // Migrate existing regions to have order field
                await migrateRegionOrders();

                loadRegions();
            } else {
                window.location.href = window.location.origin + '/lobby/lobby.html';
            }
        });
    });

    async function migrateRegionOrders() {
        try {
            const regionsRef = collection(db, "artifacts", appId, "public", "data", "regions");
            const snapshot = await getDocs(regionsRef);

            // Get all regions
            const regions = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                regions.push({
                    id: doc.id,
                    ref: doc.ref,
                    order: data.order,
                    createdAt: data.createdAt
                });
            });

            console.log('üîç Migration check - All regions:', regions.map(r => ({ id: r.id, order: r.order, type: typeof r.order })));

            // Check if migration is needed:
            // 1. Any region missing order field, OR
            // 2. All regions have the same order value (collision)
            const needsMigration = regions.some(r => r.order === undefined || r.order === null);
            const orderValues = regions.map(r => r.order).filter(o => o !== undefined && o !== null);

            console.log('üîç Raw orderValues:', orderValues, 'Types:', orderValues.map(v => typeof v));
            console.log('üîç First value:', orderValues[0], 'All equal to first?', orderValues.every(v => v === orderValues[0]));

            const allSameOrder = orderValues.length >= 2 && orderValues.every(v => v === orderValues[0]);

            console.log('üîç needsMigration:', needsMigration, 'allSameOrder:', allSameOrder, 'orderValues.length:', orderValues.length);

            if (!needsMigration && !allSameOrder) {
                console.log('‚úÖ All regions already have unique order values');
                return;
            }

            console.log('üîÑ Migrating region orders based on createdAt...', needsMigration ? '(missing fields)' : '(duplicate values)');

            // Sort by createdAt (newest first)
            regions.sort((a, b) => {
                const timeA = a.createdAt?.toMillis?.() || 0;
                const timeB = b.createdAt?.toMillis?.() || 0;
                return timeB - timeA; // Descending (newest first)
            });

            // Assign orders (newest gets highest number)
            const updates = [];
            regions.forEach((region, index) => {
                const order = (regions.length - index) * 1000;
                console.log(`  Setting order ${order} for region: ${region.id}`);
                updates.push(
                    updateDoc(region.ref, { order: order })
                );
            });

            await Promise.all(updates);
            console.log('‚úÖ Region order migration complete');
        } catch (e) {
            console.error('‚ùå Migration error:', e);
            console.error('Error details:', e.message, e.code);
            // Don't block the UI if migration fails
        }
    }

    function loadRegions() {
        // Try to load with order field, fallback to createdAt if index doesn't exist
        const regionsRef = collection(db, "artifacts", appId, "public", "data", "regions");

        onSnapshot(regionsRef, (snapshot) => {
            const list = document.getElementById('region-list');
            list.innerHTML = "";

            // Get all regions and sort manually by order field
            const regions = [];
            snapshot.forEach(snap => {
                const data = snap.data();
                regions.push({
                    id: snap.id,
                    data: data,
                    order: data.order !== undefined && data.order !== null ? data.order : 0
                });
            });

            // Sort by order field (ascending)
            regions.sort((a, b) => a.order - b.order);

            console.log('üìã Regions loaded and sorted:', regions.map(r => ({ name: r.data.name, order: r.order })));

            regions.forEach((region, index) => {
                const r = region.data;
                const div = document.createElement('div');
                div.className = `item ${activeRegionId === region.id ? 'active' : ''}`;
                div.onclick = () => selectRegion(region.id, r);

                const typeIcon = r.type === 'lecture' ? 'üéì' : 'üéÆ';
                const typeInfo = r.type === 'lecture'
                    ? `Max ${r.maxTables || 3} tables, ${r.maxStudents || 50} students`
                    : `${r.baseTime}m + ${r.increment}s`;

                // Show up arrow unless first, show down arrow unless last
                const showUp = index > 0;
                const showDown = index < regions.length - 1;

                div.innerHTML = `
                    <strong>${typeIcon} ${r.name}</strong><small>${typeInfo}</small>
                    <div class="region-controls">
                        ${showUp ? `<button class="btn-reorder" onclick="event.stopPropagation(); moveRegion('${region.id}', 'up')" title="Move Up">‚ñ≤</button>` : ''}
                        ${showDown ? `<button class="btn-reorder" onclick="event.stopPropagation(); moveRegion('${region.id}', 'down')" title="Move Down">‚ñº</button>` : ''}
                    </div>
                    <button class="btn-del-region" onclick="event.stopPropagation(); deleteRegion('${region.id}')">√ó</button>
                `;
                list.appendChild(div);
            });
        });
    }

    let currentRegionType = 'game'; // Track current region type

    window.selectRegion = (rid, data) => {
        activeRegionId = rid;
        currentRegionType = data.type || 'game'; // Store region type

        // Show Region Editor and populate
        document.getElementById('region-editor-card').style.display = 'block';
        document.getElementById('edit-reg-name').value = data.name;

        // Set region type badge
        const isLecture = data.type === 'lecture';
        const badge = document.getElementById('region-type-badge');
        badge.textContent = isLecture ? 'üéì LECTURE HALL' : 'üéÆ GAME REGION';
        badge.style.background = isLecture ? '#dbeafe' : '#e2e8f0';
        badge.style.color = isLecture ? '#1e40af' : '#64748b';

        // Show/hide appropriate fields
        if (isLecture) {
            document.getElementById('edit-game-fields').style.display = 'none';
            document.getElementById('edit-lecture-fields').style.display = 'block';
            document.getElementById('edit-reg-max-tables').value = data.maxTables || 3;
            document.getElementById('edit-reg-max-students').value = data.maxStudents || 50;
        } else {
            document.getElementById('edit-game-fields').style.display = 'grid';
            document.getElementById('edit-lecture-fields').style.display = 'none';
            document.getElementById('edit-reg-time').value = data.baseTime;
            document.getElementById('edit-reg-inc').value = data.increment;
        }

        document.getElementById('add-table-btn').style.display = 'block';
        document.getElementById('mass-reset-btn').style.display = 'block';

        loadRegions();
        loadTables(rid);
    };

    window.updateRegionSettings = async () => {
        if (!activeRegionId) return;
        const name = document.getElementById('edit-reg-name').value;

        if (!name) return alert("Region name required.");

        try {
            // Get current region data to check type
            const regionDoc = await getDoc(doc(db, "artifacts", appId, "public", "data", "regions", activeRegionId));
            const currentData = regionDoc.data();
            const isLecture = currentData.type === 'lecture';

            const updateData = { name };

            if (isLecture) {
                // Lecture region updates
                updateData.maxTables = parseInt(document.getElementById('edit-reg-max-tables').value);
                updateData.maxStudents = parseInt(document.getElementById('edit-reg-max-students').value);

                // Update password only if a new one is provided
                const newPassword = document.getElementById('edit-reg-password').value;
                if (newPassword) {
                    // Simple hash (in production, use bcrypt or similar)
                    updateData.passwordHash = btoa(newPassword);
                }
            } else {
                // Game region updates
                updateData.baseTime = parseInt(document.getElementById('edit-reg-time').value);
                updateData.increment = parseInt(document.getElementById('edit-reg-inc').value);
            }

            await updateDoc(doc(db, "artifacts", appId, "public", "data", "regions", activeRegionId), updateData);
            alert("Region details updated successfully.");
        } catch (e) { alert("Error: " + e.message); }
    };

    function loadTables(rid) {
        if (tablesUnsubscribe) tablesUnsubscribe();
        const q = query(collection(db, "artifacts", appId, "public", "data", "regions", rid, "tables"), orderBy("order", "asc"));

        tablesUnsubscribe = onSnapshot(q, (snapshot) => {
            const container = document.getElementById('table-container');
            container.innerHTML = "";
            const isLecture = currentRegionType === 'lecture';

            snapshot.forEach(tableSnap => {
                const t = tableSnap.data();
                const card = document.createElement('div');
                card.className = "table-card";

                // Different fields for lecture vs game tables
                const announcementField = isLecture
                    ? `<div class="form-group">
                        <label>üì¢ Announcement</label>
                        <textarea id="announcement-${tableSnap.id}" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:8px; resize:vertical; min-height:60px; box-sizing:border-box; font-family:inherit;">${t.announcement || ''}</textarea>
                    </div>`
                    : '';

                card.innerHTML = `
                    <h3>${isLecture ? 'üéì' : 'üéÆ'} TABLE: ${tableSnap.id}</h3>
                    <div class="form-group">
                        <label>Display Name</label>
                        <input type="text" id="name-${tableSnap.id}" value="${t.tableName || ''}">
                    </div>
                    ${announcementField}
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:10px;">
                        <button class="btn btn-success btn-sm" onclick="saveTable('${tableSnap.id}')">Save</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteTable('${tableSnap.id}')">Delete</button>
                        <button class="btn btn-reset btn-sm" style="grid-column: span 2;" onclick="adminFullReset('${tableSnap.id}')">FORCE FULL RESET ü•æ</button>
                    </div>
                `;
                container.appendChild(card);
            });
        });
    }

    window.adminFullReset = async (tableId, silent = false) => {
        if (!activeRegionId) return;
        if (!silent && !confirm("Kick players and wipe history for this table?")) return;

        try {
            const tableRef = doc(db, "artifacts", appId, "public", "data", "regions", activeRegionId, "tables", tableId);
            await updateDoc(tableRef, { playerRed: deleteField(), playerBlack: deleteField(), observers: 0 });

            const gameRef = doc(db, "artifacts", appId, "public", "data", "games", tableId);
            await setDoc(gameRef, {
                board: null,
                turn: 'red',
                history: [],
                status: 'waiting',
                chat: [],
                clocks: null,
                lastMoveTime: null
            }, { merge: true });
        } catch (e) { console.error("Reset Failed for " + tableId, e); }
    };

    window.adminMassReset = async () => {
        if (!activeRegionId) return;
        if (!confirm("CRITICAL ACTION: This will kick ALL players and reset ALL tables in this region. Continue?")) return;

        const tablesRef = collection(db, "artifacts", appId, "public", "data", "regions", activeRegionId, "tables");
        const snap = await getDocs(tablesRef);
        const promises = [];
        snap.forEach(docSnap => promises.push(window.adminFullReset(docSnap.id, true)));
        await Promise.all(promises);
    };

    window.saveTable = async (tid) => {
        const newName = document.getElementById(`name-${tid}`).value;
        const updateData = { tableName: newName };

        // If lecture region, also save announcement
        if (currentRegionType === 'lecture') {
            const announcementEl = document.getElementById(`announcement-${tid}`);
            if (announcementEl) {
                updateData.announcement = announcementEl.value;
            }
        }

        await updateDoc(doc(db, "artifacts", appId, "public", "data", "regions", activeRegionId, "tables", tid), updateData);
        alert("Table saved successfully!");
    };

    window.deleteTable = async (tid) => {
        if (confirm("Delete this table forever?")) {
            await deleteDoc(doc(db, "artifacts", appId, "public", "data", "regions", activeRegionId, "tables", tid));
        }
    };

    window.forceFixOrdering = async () => {
        alert('Function called!'); // TEST: Does this show?
        console.log('üîß FORCE FIX ORDERING - Manual trigger');

        try {
            const regionsRef = collection(db, "artifacts", appId, "public", "data", "regions");
            const snapshot = await getDocs(regionsRef);

            const regions = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                regions.push({
                    id: doc.id,
                    ref: doc.ref,
                    order: data.order,
                    createdAt: data.createdAt,
                    name: data.name
                });
            });

            console.log('üìã Current regions:', regions.map(r => ({ name: r.name, order: r.order })));

            // Sort by createdAt (newest first to match existing logic)
            regions.sort((a, b) => {
                const timeA = a.createdAt?.toMillis?.() || 0;
                const timeB = b.createdAt?.toMillis?.() || 0;
                return timeB - timeA; // Descending (newest first)
            });

            // Assign sequential orders
            const updates = [];
            regions.forEach((region, index) => {
                const newOrder = (regions.length - index) * 1000;
                console.log(`  üìù Setting order ${newOrder} for: ${region.name} (${region.id})`);
                updates.push(
                    updateDoc(region.ref, { order: newOrder })
                );
            });

            await Promise.all(updates);
            console.log('‚úÖ Region ordering fixed successfully!');
            alert('Region ordering has been fixed! The up/down arrows should now work.');
        } catch (e) {
            console.error('‚ùå Error fixing order:', e);
            alert('Error: ' + e.message);
        }
    };

    window.moveRegion = async (rid, direction) => {
        console.log(`üîò moveRegion clicked: ${rid} direction: ${direction}`);

        try {
            // Get all regions
            const regionsRef = collection(db, "artifacts", appId, "public", "data", "regions");
            const snapshot = await getDocs(regionsRef);

            const regions = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                regions.push({
                    id: doc.id,
                    order: data.order !== undefined && data.order !== null ? data.order : 0
                });
            });

            // Sort by order (ascending)
            regions.sort((a, b) => a.order - b.order);

            console.log('üìã Current order before move:', regions.map(r => ({ id: r.id, order: r.order })));

            // Find current region index
            const currentIndex = regions.findIndex(r => r.id === rid);
            if (currentIndex === -1) {
                console.error('Region not found:', rid);
                return;
            }

            // Calculate new index
            const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
            if (newIndex < 0 || newIndex >= regions.length) {
                console.log('Cannot move further in that direction');
                return;
            }

            // Swap orders
            const currentOrder = regions[currentIndex].order;
            const swapOrder = regions[newIndex].order;

            console.log(`üîÑ Swapping: ${regions[currentIndex].id} (${currentOrder}) ‚ÜîÔ∏è ${regions[newIndex].id} (${swapOrder})`);

            if (currentOrder === swapOrder) {
                console.error('‚ö†Ô∏è WARNING: Both regions have the same order value! Cannot swap. Run migration first.');
                alert('Cannot reorder: regions have duplicate order values. Please refresh the page to trigger migration.');
                return;
            }

            await updateDoc(doc(db, "artifacts", appId, "public", "data", "regions", rid), { order: swapOrder });
            await updateDoc(doc(db, "artifacts", appId, "public", "data", "regions", regions[newIndex].id), { order: currentOrder });

            console.log(`‚úÖ Moved ${rid} ${direction}`);
        } catch (e) {
            console.error("‚ùå Error moving region:", e);
            alert("Error: " + e.message);
        }
    };

    window.deleteRegion = async (rid) => {
        if (confirm("Delete this entire region and all its tables? This cannot be undone.")) {
            await deleteDoc(doc(db, "artifacts", appId, "public", "data", "regions", rid));
            if (activeRegionId === rid) {
                activeRegionId = null;
                document.getElementById('region-editor-card').style.display = 'none';
                document.getElementById('table-container').innerHTML = "<p style='color:#94a3b8; padding: 40px; text-align: center; width: 100%;'>Select a region to manage tables.</p>";
            }
        }
    };

    window.createRegion = async () => {
        const name = document.getElementById('reg-name').value;
        const type = document.getElementById('reg-type').value;

        if (!name) return alert("Region name required.");

        // Get current max order to append new region at the end
        const regionsRef = collection(db, "artifacts", appId, "public", "data", "regions");
        const snapshot = await getDocs(regionsRef);
        let maxOrder = 0;
        snapshot.forEach(doc => {
            const order = doc.data().order || 0;
            if (order > maxOrder) maxOrder = order;
        });

        const regionData = {
            name,
            type,
            createdAt: serverTimestamp(),
            order: maxOrder + 1000 // Add 1000 to allow reordering
        };

        if (type === 'lecture') {
            // Lecture region
            const password = document.getElementById('reg-password').value;
            if (!password) return alert("Lecturer password required for lecture halls.");

            regionData.passwordHash = btoa(password); // Simple hash (use bcrypt in production)
            regionData.maxTables = parseInt(document.getElementById('reg-max-tables').value) || 3;
            regionData.maxStudents = parseInt(document.getElementById('reg-max-students').value) || 50;
        } else {
            // Game region
            regionData.baseTime = parseInt(document.getElementById('reg-time').value);
            regionData.increment = parseInt(document.getElementById('reg-inc').value);
        }

        await addDoc(collection(db, "artifacts", appId, "public", "data", "regions"), regionData);
        closeModals();
    };

    window.createTable = async () => {
        const name = document.getElementById('tab-name').value;
        if (!name || !activeRegionId) return;
        await addDoc(collection(db, "artifacts", appId, "public", "data", "regions", activeRegionId, "tables"), { tableName: name, order: Date.now(), observers: 0 });
        closeModals();
    };

    window.toggleLectureFields = () => {
        const type = document.getElementById('reg-type').value;
        const isLecture = type === 'lecture';

        document.getElementById('game-fields').style.display = isLecture ? 'none' : 'block';
        document.getElementById('lecture-fields').style.display = isLecture ? 'block' : 'none';
    };

    window.showAddRegion = () => {
        // Reset form and show game fields by default
        document.getElementById('reg-type').value = 'game';
        document.getElementById('game-fields').style.display = 'block';
        document.getElementById('lecture-fields').style.display = 'none';
        document.getElementById('region-modal').style.display = 'flex';
    };

    window.showAddTable = () => document.getElementById('table-modal').style.display = 'flex';
    window.closeModals = () => document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');

    // User Management Functions
    let usersUnsubscribe = null;

    window.toggleUserManagement = () => {
        const userSection = document.getElementById('user-management-section');
        const regionColumn = document.getElementById('region-column');
        const tablesColumn = document.getElementById('tables-column');

        if (userSection.style.display === 'none') {
            // Show user management
            userSection.style.display = 'block';
            regionColumn.style.display = 'none';
            tablesColumn.style.display = 'none';
            loadUserManagement();
        } else {
            // Hide user management
            userSection.style.display = 'none';
            regionColumn.style.display = 'block';
            tablesColumn.style.display = 'block';
            if (usersUnsubscribe) {
                usersUnsubscribe();
                usersUnsubscribe = null;
            }
        }
    };

    async function loadUserManagement() {
        try {
            console.log('üîç Loading user management data...');

            // Step 1: Load ALL users from the users collection
            const userMap = new Map();
            const currentUser = auth.currentUser;

            if (!currentUser) {
                console.error('No current user!');
                return;
            }

            // Get all user profiles from artifacts/sg-xiangqi/users/*/profile/data
            // Note: This requires Firestore rules to allow admins to list users
            const usersCollectionRef = collection(db, 'artifacts', appId, 'users');
            let usersSnapshot;

            try {
                usersSnapshot = await getDocs(usersCollectionRef);
                console.log(`üìä Found ${usersSnapshot.size} user documents in collection`);
            } catch (err) {
                console.error('‚ùå Cannot read users collection:', err);
                alert('Cannot read users collection. This may be a permissions issue. Please check Firestore rules.');
                return;
            }

            const now = Date.now();

            // Load each user's profile data
            for (const userDoc of usersSnapshot.docs) {
                const uid = userDoc.id;
                try {
                    const profileRef = doc(db, 'artifacts', appId, 'users', uid, 'profile', 'data');
                    const profileSnap = await getDoc(profileRef);

                    if (profileSnap.exists()) {
                        const profile = profileSnap.data();
                        userMap.set(uid, {
                            uid,
                            email: profile.email || 'N/A',
                            playerName: profile.playerName || 'Anonymous',
                            role: profile.role || 'user',
                            lastSeen: profile.lastSeen || 0,
                            gamesPlayed: 0,
                            lastTable: '-',
                            currentTable: null
                        });
                    }
                } catch (err) {
                    console.log(`Cannot read profile for user ${uid}:`, err.message);
                }
            }

            console.log(`‚úÖ Loaded ${userMap.size} user profiles`);

            // Step 2: Check who's currently online (seated at tables)
            const regionsRef = collection(db, 'artifacts', appId, 'public', 'data', 'regions');
            const regionsSnap = await getDocs(regionsRef);

            for (const regionDoc of regionsSnap.docs) {
                const tablesRef = collection(db, 'artifacts', appId, 'public', 'data', 'regions', regionDoc.id, 'tables');
                const tablesSnap = await getDocs(tablesRef);

                for (const tableDoc of tablesSnap.docs) {
                    const table = tableDoc.data();

                    // Check Red Player
                    if (table.playerRed?.uid && userMap.has(table.playerRed.uid)) {
                        const userData = userMap.get(table.playerRed.uid);
                        userData.currentTable = tableDoc.id;
                        userData.lastSeen = now;
                    }

                    // Check Black Player
                    if (table.playerBlack?.uid && userMap.has(table.playerBlack.uid)) {
                        const userData = userMap.get(table.playerBlack.uid);
                        userData.currentTable = tableDoc.id;
                        userData.lastSeen = now;
                    }
                }
            }

            // Step 3: Count games played (from game history)
            for (const regionDoc of regionsSnap.docs) {
                const tablesRef = collection(db, 'artifacts', appId, 'public', 'data', 'regions', regionDoc.id, 'tables');
                const tablesSnap = await getDocs(tablesRef);

                for (const tableDoc of tablesSnap.docs) {
                    const table = tableDoc.data();

                    // Check both players
                    for (const player of [table.playerRed, table.playerBlack]) {
                        if (player?.uid && userMap.has(player.uid)) {
                            try {
                                const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', tableDoc.id);
                                const gameSnap = await getDoc(gameRef);

                                if (gameSnap.exists()) {
                                    const game = gameSnap.data();
                                    const history = game.history || [];

                                    if (history.length > 0) {
                                        const userData = userMap.get(player.uid);
                                        userData.gamesPlayed++;
                                        userData.lastTable = tableDoc.id;

                                        // Update last seen based on last move time
                                        const lastMove = history[history.length - 1];
                                        if (lastMove?.ts) {
                                            userData.lastSeen = Math.max(userData.lastSeen, lastMove.ts);
                                        }
                                    }
                                }
                            } catch (err) {
                                console.error('Error counting games for table', tableDoc.id, err);
                            }
                        }
                    }
                }
            }

            const users = Array.from(userMap.values());

            const oneDayAgo = now - (24 * 60 * 60 * 1000);

            // Update statistics
            document.getElementById('total-users').textContent = users.length;
            document.getElementById('online-users').textContent = users.filter(u => u.currentTable).length;
            document.getElementById('active-today').textContent = users.filter(u => u.lastSeen > oneDayAgo).length;
            document.getElementById('admin-count').textContent = users.filter(u => u.role === 'admin').length;

            // Sort by last seen (most recent first)
            users.sort((a, b) => b.lastSeen - a.lastSeen);

            // Render table
            const tbody = document.getElementById('user-table-body');
            tbody.innerHTML = '';

            users.forEach(user => {
                const row = document.createElement('tr');

                const isOnline = user.currentTable !== null;
                const statusClass = isOnline ? 'status-online' : 'status-offline';
                const statusText = isOnline ? 'üü¢ Online' : '‚ö´ Offline';

                const lastSeenText = user.lastSeen > 0
                    ? formatRelativeTime(user.lastSeen)
                    : 'Never';

                const sessionText = isOnline ? 'Active' : '-';

                const roleBadge = user.role === 'admin'
                    ? '<span class="badge badge-admin">ADMIN</span>'
                    : '<span class="badge badge-user">USER</span>';

                const actionButton = user.role === 'admin'
                    ? `<button class="btn btn-sm" style="background:#ef4444; color:white;" onclick="toggleUserRole('${user.uid}', 'user')">Demote to User</button>`
                    : `<button class="btn btn-sm" style="background:#10b981; color:white;" onclick="toggleUserRole('${user.uid}', 'admin')">Promote to Admin</button>`;

                row.innerHTML = `
                    <td style="font-family: monospace; font-size: 0.75rem; color: #64748b;">${user.uid.substring(0, 8)}...</td>
                    <td><strong>${user.playerName}</strong></td>
                    <td>${user.email}</td>
                    <td>${roleBadge}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>${lastSeenText}</td>
                    <td>${sessionText}</td>
                    <td style="text-align: center;">${user.gamesPlayed}</td>
                    <td style="font-family: monospace; font-size: 0.8rem;">${user.currentTable || user.lastTable}</td>
                    <td>${actionButton}</td>
                `;
                tbody.appendChild(row);
            });
        } catch (e) {
            console.error('Error loading user management:', e);
            alert('Error loading users: ' + e.message);
        }
    }

    function formatRelativeTime(timestamp) {
        const now = Date.now();
        const diff = now - timestamp;
        const seconds = Math.floor(diff / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (seconds < 60) return 'Just now';
        if (minutes < 60) return `${minutes}m ago`;
        if (hours < 24) return `${hours}h ago`;
        if (days < 7) return `${days}d ago`;

        const date = new Date(timestamp);
        return date.toLocaleDateString();
    }

    function formatDuration(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;

        if (hours > 0) return `${hours}h ${minutes}m`;
        if (minutes > 0) return `${minutes}m ${secs}s`;
        return `${secs}s`;
    }

    window.toggleUserRole = async (uid, newRole) => {
        const action = newRole === 'admin' ? 'promote to Admin' : 'demote to User';

        if (!confirm(`Are you sure you want to ${action} this user?`)) {
            return;
        }

        try {
            const profileRef = doc(db, 'artifacts', appId, 'users', uid, 'profile', 'data');
            await updateDoc(profileRef, {
                role: newRole
            });

            alert(`User successfully ${newRole === 'admin' ? 'promoted' : 'demoted'}!`);

            // Reload user management to reflect changes
            loadUserManagement();
        } catch (e) {
            console.error('Error updating user role:', e);

            if (e.code === 'permission-denied') {
                alert('‚ö†Ô∏è Permission denied: You need admin privileges to change user roles.\n\nPlease ensure:\n1. You are logged in as an admin\n2. Your Firestore security rules allow admins to update user profiles');
            } else {
                alert('Error updating user role: ' + e.message);
            }
        }
    };
</script>
</body>
</html>