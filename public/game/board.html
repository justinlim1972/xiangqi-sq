<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SG Xiangqi - General's Arena</title>
    <style>
        :root {
            --gold: #f1c40f; --primary: #cd3333; --dark: #05080c;
            --panel-bg: #111; --hint: rgba(34, 197, 94, 0.4);
            --board-line: #5d2e0c;
        }
        body { 
            margin: 0; background: var(--dark); color: #eee; 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            display: flex; height: 100vh; overflow: hidden; 
        }
        
        /* THE STAGE */
        main { 
            flex-grow: 1; position: relative; display: flex; 
            align-items: center; justify-content: center; background: #000; 
            overflow: hidden;
        }

        /* ATMOSPHERIC BACKGROUND */
        #environment-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://images.unsplash.com/photo-1508804185872-d7badad00f7d?q=80&w=1200');
            background-size: cover; background-position: center;
            filter: brightness(1.0) blur(2px); z-index: 1;
        }

        .board-container {
            position: relative; z-index: 5; 
            width: 85vh; max-width: 95vw;
            aspect-ratio: 10/11; border: 12px solid #2a1a10;
            background: #dcb35c; 
            box-shadow: 0 40px 100px rgba(0,0,0,0.9), 0 0 20px rgba(241, 196, 15, 0.2);
            border-radius: 4px;
        }

        /* SVG & LAYERS */
        #board-svg { width: 100%; height: 100%; display: block; }
        #hints-layer, #pieces-layer { 
            position: absolute; top: 0; left: 0; 
            width: 100%; height: 100%; pointer-events: none; 
        }
        #pieces-layer { z-index: 10; pointer-events: auto; }
        #hints-layer { z-index: 30; pointer-events: none; }

        /* PIECE STYLING */
        .piece { 
            position: absolute; width: 9.1%; height: 8.2%; 
            transform: translate(-50%, -50%); 
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            z-index: 20; cursor: pointer; 
        }
        
        .piece-selected {
            filter: drop-shadow(0 0 15px #f1c40f) brightness(1.3);
            transform: translate(-50%, -50%) scale(1.1);
            z-index: 25 !important;
        }
        
        .opponent-selected {
            filter: drop-shadow(0 0 15px #cd3333) brightness(1.2);
            animation: opponentPulse 1s ease-in-out infinite;
        }
        
        @keyframes opponentPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes timerPulse {
            0%, 100% { 
                transform: scale(1); 
                opacity: 1;
            }
            50% { 
                transform: scale(1.1); 
                opacity: 0.8;
            }
        }
        
        /* MOVE HINTS */
        .move-hint {
            position: absolute;
            width: 9%;
            height: 8.2%;
            transform: translate(-50%, -50%);
            background: var(--hint);
            border: 2px solid #22c55e;
            border-radius: 50%;
            z-index: 15;
            cursor: pointer;
            pointer-events: auto;
        }

        /* SIDEBAR INTERFACE */
        #sidebar { 
            width: 380px; background: var(--panel-bg); 
            border-left: 2px solid #222; display: flex; 
            flex-direction: column; z-index: 100; flex-shrink: 0;
        }
        
        /* REWARD BANNER */
        .reward-banner { 
            background: #000; padding: 15px; 
            border-bottom: 2px solid var(--gold); text-align: center; 
        }
        .reward-banner span { 
            font-size: 0.65rem; color: var(--gold); 
            text-transform: uppercase; font-weight: 800; 
            letter-spacing: 2px; display: block; margin-bottom: 5px; 
        }
        .reward-tile { 
            font-size: 2.8rem; filter: drop-shadow(0 0 10px rgba(241, 196, 15, 0.5)); 
        }

        .p-block { 
            padding: 15px; background: #080808; 
            display: flex; flex-direction: column; gap: 8px; 
            border-bottom: 1px solid #222; 
        }
        .p-card {
            background: #1a1a1a; padding: 10px; border-radius: 12px;
            display: flex; align-items: center; gap: 12px; border: 3px solid #333;
            transition: all 0.3s ease;
        }
        .p-card:hover {
            border-color: var(--gold);
            background: #252525;
            box-shadow: 0 0 10px rgba(241, 196, 15, 0.2);
        }
        .p-card.clickable { cursor: pointer; }
        .p-card.not-clickable { cursor: not-allowed; opacity: 0.6; }
        .p-card.not-clickable:hover { border-color: #333; background: #1a1a1a; box-shadow: none; }
        .p-card.occupied-red {
            border-color: #cd3333;
            border-width: 4px;
            box-shadow: 0 0 15px rgba(205, 51, 51, 0.4);
        }
        .p-card.occupied-black {
            border-color: #1e3a8a;
            border-width: 4px;
            box-shadow: 0 0 15px rgba(30, 58, 138, 0.4);
        }
        .p-card.empty-slot {
            border-color: #333;
            border-width: 3px;
        }
        .p-avatar { 
            width: 42px; height: 42px; border-radius: 50%; 
            overflow: hidden; border: 2px solid #444; 
        }
        .p-avatar img { width: 100%; height: 100%; object-fit: cover; }

        /* PRESENCE LIST - SCROLLABLE */
        .presence-header { 
            background: #000; padding: 10px 15px; border-bottom: 1px solid #222; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .presence-header span { 
            font-size: 0.6rem; color: var(--gold); 
            font-weight: 900; letter-spacing: 2px; 
        }
        
        #presence-list {
            max-height: 200px; overflow-y: auto;
            background: #050505; border-bottom: 1px solid #222;
        }
        .presence-item { 
            padding: 8px 12px; font-size: 0.65rem; display: flex; flex-direction: column; 
            border-bottom: 1px solid rgba(255,255,255,0.05);
            background: white; color: black; /* DEFAULT OBSERVER */
            transition: 0.3s;
        }
        .presence-item strong { display: block; font-weight: 900; text-transform: uppercase; }
        .presence-item em { font-size: 0.55rem; opacity: 0.6; font-style: normal; display: block; }

        .p-red { background: var(--primary) !important; color: white !important; }
        .p-black { background: #000 !important; color: white !important; border-bottom-color: #333 !important; }

        /* BUTTONS */
        .btn-action { 
            width: 100%; padding: 12px; border-radius: 8px; border: none; 
            font-weight: 900; cursor: pointer; font-size: 0.8rem; 
            text-transform: uppercase; transition: 0.2s;
        }
        .btn-red { background: var(--primary); color: white; }
        .btn-blue { background: #3498db; color: white; }
        .btn-green { background: #27ae60; color: white; margin-top: 10px; }
        .btn-action:disabled { opacity: 0.3; cursor: not-allowed; }

        #chat-log { 
            flex-grow: 1; overflow-y: auto; padding: 15px; 
            background: #050505; font-size: 0.8rem; 
        }
        .chat-msg { 
            margin-bottom: 8px; padding: 8px 12px; 
            background: #111; border-radius: 8px; 
            border-left: 3px solid var(--gold); 
        }
        
        .chat-input { padding: 12px; background: #000; border-top: 1px solid #222; }
        .chat-input input { 
            width: 100%; background: #111; border: 1px solid #333; 
            color: white; padding: 12px; border-radius: 8px; 
            outline: none; box-sizing: border-box; 
        }

        .bottom-nav { padding: 12px; background: #050505; border-top: 1px solid #222; }

        #loader { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: #05080c; z-index: 9999; display: flex; 
            flex-direction: column; align-items: center; justify-content: center; 
        }
        .spin {
            width: 40px; height: 40px; border: 4px solid #111;
            border-top-color: var(--gold); border-radius: 50%;
            animation: s 1s linear infinite;
        }
        @keyframes s { to { transform: rotate(360deg); } }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 15px rgba(241, 196, 15, 0.4); }
            50% { box-shadow: 0 0 30px rgba(241, 196, 15, 0.8); }
        }
    </style>
</head>
<body>

<div id="loader">
    <div class="spin"></div>
    <p style="margin-top:20px; color:var(--gold); font-weight:bold; letter-spacing: 2px;">SYNCING ARENA...</p>
</div>

<!-- TEST: UNSEAT button moved to top to test z-index blocking 
<div style="position: fixed; top: 10px; right: 10px; z-index: 99999;">
    <button id="btn-unseat-test" class="btn-action btn-red" style="display:none; padding: 15px 30px; font-size: 18px;" onclick="window.app.unseat()">üö™ UNSEAT (TEST)</button>
</div>-->

<main>
    <div id="environment-bg"></div>
    <div class="board-container">
        <!-- HARDCODED GRID: Guaranteed visual board even if JS Handshake is slow -->
        <svg id="board-svg" viewBox="0 0 100 110" preserveAspectRatio="xMidYMid meet">
            <!-- Horizontal Lines -->
            <g stroke="var(--board-line)" stroke-width="0.4">
                <line x1="10" y1="10" x2="90" y2="10" />
                <line x1="10" y1="20" x2="90" y2="20" />
                <line x1="10" y1="30" x2="90" y2="30" />
                <line x1="10" y1="40" x2="90" y2="40" />
                <line x1="10" y1="50" x2="90" y2="50" />
                <line x1="10" y1="60" x2="90" y2="60" />
                <line x1="10" y1="70" x2="90" y2="70" />
                <line x1="10" y1="80" x2="90" y2="80" />
                <line x1="10" y1="90" x2="90" y2="90" />
                <line x1="10" y1="100" x2="90" y2="100" />
            </g>
            <!-- Vertical Lines (Split by River) -->
            <g stroke="var(--board-line)" stroke-width="0.4">
                <line x1="10" y1="10" x2="10" y2="100" />
                <line x1="20" y1="10" x2="20" y2="50" /> <line x1="20" y1="60" x2="20" y2="100" />
                <line x1="30" y1="10" x2="30" y2="50" /> <line x1="30" y1="60" x2="30" y2="100" />
                <line x1="40" y1="10" x2="40" y2="50" /> <line x1="40" y1="60" x2="40" y2="100" />
                <line x1="50" y1="10" x2="50" y2="50" /> <line x1="50" y1="60" x2="50" y2="100" />
                <line x1="60" y1="10" x2="60" y2="50" /> <line x1="60" y1="60" x2="60" y2="100" />
                <line x1="70" y1="10" x2="70" y2="50" /> <line x1="70" y1="60" x2="70" y2="100" />
                <line x1="80" y1="10" x2="80" y2="50" /> <line x1="80" y1="60" x2="80" y2="100" />
                <line x1="90" y1="10" x2="90" y2="100" />
            </g>
            <!-- Palaces -->
            <g stroke="var(--board-line)" stroke-width="0.4">
                <line x1="40" y1="10" x2="60" y2="30" />
                <line x1="60" y1="10" x2="40" y2="30" />
                <line x1="40" y1="80" x2="60" y2="100" />
                <line x1="60" y1="80" x2="40" y2="100" />
            </g>
            <!-- River Text -->
            <g font-family="serif" font-weight="900" font-size="4.5" fill="var(--board-line)" opacity="0.7">
                <text x="30" y="56.5" text-anchor="middle">Ê•ö Ê≤≥</text>
                <text x="70" y="56.5" text-anchor="middle">Êº¢ Áïå</text>
            </g>
            <!-- Border -->
            <rect x="10" y="10" width="80" height="90" fill="none" stroke="var(--board-line)" stroke-width="1.2" />
            
            <!-- Coordinates -->
            <g font-size="3.5" fill="var(--board-line)" font-weight="bold" text-anchor="middle">
                <text x="10" y="6.5">1</text><text x="20" y="6.5">2</text><text x="30" y="6.5">3</text>
                <text x="40" y="6.5">4</text><text x="50" y="6.5">5</text><text x="60" y="6.5">6</text>
                <text x="70" y="6.5">7</text><text x="80" y="6.5">8</text><text x="90" y="6.5">9</text>
                
                <text x="10" y="106.8">‰πù</text><text x="20" y="106.8">ÂÖ´</text><text x="30" y="106.8">‰∏É</text>
                <text x="40" y="106.8">ÂÖ≠</text><text x="50" y="106.8">‰∫î</text><text x="60" y="106.8">Âõõ</text>
                <text x="70" y="106.8">‰∏â</text><text x="80" y="106.8">‰∫å</text><text x="90" y="106.8">‰∏Ä</text>
            </g>
        </svg>
        <div id="hints-layer"></div>
        <div id="pieces-layer"></div>
    </div>
</main>

<div id="sidebar">
    <!-- Victory Reward Banner -->
    <div class="reward-banner">
        <span>Victory Reward</span>
        <div id="match-reward-tile" class="reward-tile">üÄÑ</div>
    </div>

    <!-- Players Info -->
    <div class="p-block">
        <div id="player-card-black" class="p-card" style="flex-direction: column; align-items: stretch; gap: 8px; cursor: pointer; transition: 0.2s;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div class="p-avatar"><img src="/lobby/1.JPG" id="avatar-black"></div>
                <span id="name-black" style="flex-grow: 1;">Empty Slot</span>
            </div>
            <div id="black-timer" style="
                display: none;
                font-family: 'Courier New', monospace; 
                font-weight: 900; 
                font-size: 2.2rem; 
                color: #f1c40f; 
                text-align: center;
                background: rgba(0,0,0,0.5);
                padding: 8px;
                border-radius: 8px;
                letter-spacing: 3px;
                text-shadow: 0 0 20px rgba(241, 196, 15, 0.8);
            ">00:15:00</div>
        </div>
        <div id="player-card-red" class="p-card" style="flex-direction: column; align-items: stretch; gap: 8px; cursor: pointer; transition: 0.2s;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div class="p-avatar"><img src="/lobby/1.JPG" id="avatar-red"></div>
                <span id="name-red" style="flex-grow: 1;">Empty Slot</span>
            </div>
            <div id="red-timer" style="
                display: none;
                font-family: 'Courier New', monospace; 
                font-weight: 900; 
                font-size: 2.2rem; 
                color: #f1c40f; 
                text-align: center;
                background: rgba(0,0,0,0.5);
                padding: 8px;
                border-radius: 8px;
                letter-spacing: 3px;
                text-shadow: 0 0 20px rgba(241, 196, 15, 0.8);
            ">00:15:00</div>
        </div>
        
        <!-- Action Menu (appears when clicking player slots) -->
        <div id="action-menu" style="display: none; margin-top: 10px; background: #0a0a0a; border: 2px solid var(--gold); border-radius: 12px; padding: 10px; position: relative; z-index: 100;">
            <div id="action-menu-title" style="color: var(--gold); font-size: 0.7rem; font-weight: 800; text-align: center; margin-bottom: 8px; letter-spacing: 1px;"></div>
            <div id="action-menu-buttons" style="display: flex; flex-direction: column; gap: 6px;"></div>
        </div>

        <!-- Draw Offer Modal (restricted to sidebar area) -->
        <div id="draw-offer-modal" style="display: none; margin-top: 10px; background: #0a0a0a; border: 3px solid var(--gold); border-radius: 15px; padding: 20px; animation: pulse 2s infinite;">
            <div style="text-align: center;">
                <div style="font-size: 2.5rem; margin-bottom: 8px;">ü§ù</div>
                <h2 id="draw-offer-title" style="color: var(--gold); font-size: 1.1rem; margin-bottom: 8px; font-weight: 900; letter-spacing: 1px;">DRAW OFFER</h2>
                <p id="draw-offer-message" style="color: #eee; font-size: 0.85rem; margin-bottom: 12px; line-height: 1.4;">Your opponent offers a draw</p>
                <div id="draw-offer-countdown" style="font-size: 3rem; font-weight: 900; color: var(--gold); font-family: 'Courier New', monospace; margin-bottom: 15px; text-shadow: 0 0 20px rgba(241, 196, 15, 0.6);">10</div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button id="btn-accept-draw-modal" class="btn-action" style="background: #27ae60; color: white; padding: 12px 20px; font-size: 0.9rem; border-radius: 10px; border: none; cursor: pointer; font-weight: 900; flex: 1;">‚úÖ ACCEPT</button>
                    <button id="btn-reject-draw-modal" class="btn-action" style="background: #cd3333; color: white; padding: 12px 20px; font-size: 0.9rem; border-radius: 10px; border: none; cursor: pointer; font-weight: 900; flex: 1;">‚ùå REJECT</button>
                </div>
            </div>
        </div>

        <!-- Move Animation Overlay (appears for captures, checks, checkmate) -->
        <div id="move-animation" style="display: none; margin-top: 10px; background: #0a0a0a; border: 3px solid var(--gold); border-radius: 15px; padding: 20px;">
            <div style="text-align: center;">
                <div id="move-animation-icon" style="font-size: 2.5rem; margin-bottom: 8px;">‚öîÔ∏è</div>
                <h2 id="move-animation-chinese" style="color: var(--gold); font-size: 2.5rem; margin-bottom: 8px; font-weight: 900; letter-spacing: 3px; text-shadow: 0 0 20px rgba(241, 196, 15, 0.8);">ÂêÉ</h2>
                <p id="move-animation-english" style="color: #eee; font-size: 1rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase;">CAPTURE</p>
            </div>
        </div>

        <!-- Emergency Reset (only shows if stuck) -->
        <button id="btn-reset-match" class="btn-action" style="display:none; background:#666; margin-top: 5px;">‚ö†Ô∏è RESET MATCH</button>
    </div>
    
    <!-- Room Presence -->
    <div class="presence-header">
        <span>ROOM PRESENCE</span>
        <span id="presence-count">SYNCING...</span>
    </div>
    <div id="presence-list">
        <!-- Populated dynamically with Highlighting (Red/Black/White) -->
    </div>

    <!-- Communication -->
    <div id="chat-log"></div>
    <div class="chat-input">
        <input type="text" id="chat-msg" placeholder="Broadcast to room..." onkeydown="if(event.key==='Enter') app.sendChat()">
    </div>

    <!-- Exit -->
    <div class="bottom-nav">
        <button class="btn-action btn-blue" onclick="app.handleExit()">Exit to Lobby</button>
    </div>
</div>

<script type="module">
    import { XQApp } from "./xq-app.js";
    // Initialize the Orchestrator which manages all modules (Engine, UI, Firebase)
    window.app = new XQApp();
    window.app.init();

    // Wire up draw offer modal buttons
    document.getElementById('btn-accept-draw-modal').onclick = () => {
        window.app.acceptDraw();
    };

    document.getElementById('btn-reject-draw-modal').onclick = () => {
        window.app.rejectDraw();
    };
</script>

</body>
</html>